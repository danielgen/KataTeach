<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>Go Position Labeler</title>
<script src='web/wgo.min.js'></script>
<style>
  body { margin: 20px; font-family: Arial, sans-serif; }
  .container { display: flex; gap: 20px; max-width: 100%; }
  .board-section { flex: 0 0 520px; }
  .controls-section { flex: 1; min-width: 300px; }
  #board { width: 480px; height: 480px; }
  .game-info { 
    background: #f9f9f9; 
    padding: 8px; 
    border-radius: 5px; 
    margin-bottom: 10px;
    font-size: 14px;
    border: 1px solid #ddd;
  }
  .player-names { 
    display: flex; 
    justify-content: space-between; 
    margin-bottom: 5px;
  }
  .player-black { font-weight: bold; }
  .player-white { font-weight: bold; }
  .navigation { 
    margin: 10px 0; 
    text-align: center;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 5px;
  }
  .nav-button { 
    padding: 8px 16px; 
    margin: 0 5px; 
    background: #007bff; 
    color: white; 
    border: none; 
    border-radius: 3px; 
    cursor: pointer;
  }
  .nav-button:hover { background: #0056b3; }
  .move-counter { 
    display: inline-block; 
    margin: 0 10px; 
    font-weight: bold; 
    font-size: 16px;
  }
  .tag-block { margin: 5px 0; }
  .policy-info { 
    background: #f5f5f5; 
    padding: 10px; 
    border-radius: 5px; 
    margin: 10px 0;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
  }
  .policy-move { 
    margin: 2px 0; 
    padding: 4px 8px; 
    background: white; 
    border-radius: 3px;
    font-size: 13px;
    border-left: 3px solid #007bff;
  }
  h3 { margin-top: 20px; margin-bottom: 10px; }
  h4 { margin: 10px 0 5px 0; color: #333; }
  
  /* Hide WGo.js default controls that appear at bottom */
  .wgo-player-wrapper .wgo-player-control { display: none !important; }
  .wgo-player-wrapper .wgo-comments { display: none !important; }
  .wgo-player-wrapper .wgo-info { display: none !important; }
  .wgo-player-wrapper .wgo-infobox { display: none !important; }
  
  /* Hide WGo.js player name boxes that push the board down */
  .wgo-player__box.wgo-player__player-tag { display: none !important; }
  .wgo-player__player-tag { display: none !important; }
  
  /* Style our custom board container */
  #board { 
    border: 2px solid #333; 
    border-radius: 5px; 
    overflow: hidden;
    box-sizing: border-box;
  }
  
  /* Ensure board container doesn't overflow */
  .board-section {
    overflow: hidden;
  }
  
  /* Style only policy move labels to be red - more targeted approach */
  .policy-label {
    fill: red !important;
    color: red !important;
    font-weight: bold !important;
    font-size: 1px !important;
  }
</style>
</head>
<body>
<div class='container'>
  <div class='board-section'>
    <div class='game-info'>
      <div class='player-names'>
        <span class='player-black'>⚫ <span id='black-player'></span></span>
        <span class='player-white'>⚪ <span id='white-player'></span></span>
      </div>
      <div>Game: <span id='game-info'>Loading...</span></div>
    </div>
    <div id='board'></div>
    <div class='navigation'>
      <button id='prev' class='nav-button'>← Prev</button>
      <span class='move-counter'>Move <span id='move_idx'>0</span></span>
      <button id='next' class='nav-button'>Next →</button>
    </div>
    <div class='policy-info'>
      <h4>AI Suggestions</h4>
      <div id='policy_suggestions'></div>
    </div>
  </div>
  <div class='controls-section'>
    <form id='tag_form'></form>
    <button id='export'>Export Labels</button>
  </div>
</div>
<script>
const SGF = "(;GM[1]FF[4]\r\nSZ[19]\r\nGN[]\r\nDT[2025-01-25]\r\nPB[a531233903]\r\nPW[danielgen]\r\nBR[2\u6bb5]\r\nWR[2\u6bb5]\r\nKM[375]HA[0]RU[Chinese]AP[GNU Go:3.8]RN[3]RE[B+R]TM[300]TC[3]TT[30]AP[foxwq]RL[0]\r\n;B[pd];W[dp];B[pq];W[dd];B[cn];W[fq];B[cp];W[cq];B[bq];W[br];B[bp];W[dq];B[hq];W[cl];B[ar];W[ci];B[do];W[fo];B[eo];W[fp];B[cr];W[dr];B[bs];W[jq];B[ip];W[kp];B[ep];W[fm];B[in];W[nq];B[qo];W[jo];B[io];W[km];B[il];W[fc];B[eq];W[er];B[gr];W[fr];B[cd];W[cc];B[de];W[dc];B[bd];W[en];B[cg];W[ee];B[df];W[nc];B[lc];W[qc];B[pc];W[qd];B[qe];W[re];B[rf];W[sd];B[pf];W[pb];B[ob];W[qb];B[oc];W[qg];B[qf];W[oe];B[of];W[ne];B[pe];W[nb];B[oa];W[nf];B[md];W[nd];B[oi];W[oh];B[ph];W[pg];B[og];W[nh];B[qh];W[lf];B[ic];W[jd];B[jc];W[hb];B[kd];W[je];B[ke];W[kf];B[jf];W[if];B[jg];W[he];B[hd];W[ie];B[gd];W[ge];B[fd];W[fe];B[ed];W[ec];B[mg];W[mf];B[ng];W[lh];B[ig];W[hg];B[hh];W[gg];B[gh];W[eg];B[dh];W[fh];B[fi];W[eh];B[ei];W[ef];B[ii];W[bc];B[ki];W[kh];B[li];W[mh];B[ni];W[ka];B[mb];W[ma];B[na];W[la];B[lb];W[ia];B[hc];W[gc];B[lg];W[kg];B[mi];W[kb];B[ib];W[gb];B[ja])";
const GLOBAL_TAGS = ["tenuki_ok", "urgent_local", "game_stage_opening", "game_stage_endgame"];
const SPATIAL_TAGS = ["invasion_viable", "reduction_preferred", "big_point_corner", "sente_line", "sabaki_required", "base_weak", "aji_present", "cut_available", "ladder_works", "ladder_fails", "atari_available", "connection_required", "ko_threat", "capture_race"];
const POLICY = {"0": [{"move": "C16", "winrate": 0.34302639961242676}, {"move": "C4", "winrate": 0.3420749306678772}, {"move": "D17", "winrate": 0.3415808081626892}, {"move": "R4", "winrate": 0.3382512331008911}, {"move": "Q17", "winrate": 0.33948445320129395}, {"move": "P16", "winrate": 0.3382447361946106}, {"move": "E4", "winrate": 0.33863604068756104}, {"move": "D15", "winrate": 0.3387165069580078}, {"move": "Q15", "winrate": 0.3403916358947754}], "1": [{"move": "D4", "winrate": 0.6688219308853149}], "2": [{"move": "Q4", "winrate": 0.3376501202583313}, {"move": "D16", "winrate": 0.3373223543167114}, {"move": "C16", "winrate": 0.33553171157836914}, {"move": "D15", "winrate": 0.3347499370574951}, {"move": "C3", "winrate": 0.33438360691070557}, {"move": "O17", "winrate": 0.33670157194137573}, {"move": "E16", "winrate": 0.33544284105300903}, {"move": "Q14", "winrate": 0.3357251286506653}, {"move": "R13", "winrate": 0.33898764848709106}, {"move": "N17", "winrate": 0.336700439453125}], "3": [{"move": "D17", "winrate": 0.6548483073711395}], "4": [{"move": "O17", "winrate": 0.35908228158950806}], "5": [{"move": "Q5", "winrate": 0.670881062746048}, {"move": "D6", "winrate": 0.6680905222892761}], "6": [{"move": "C17", "winrate": 0.35704439878463745}], "7": [{"move": "C3", "winrate": 0.675608366727829}], "8": [{"move": "B3", "winrate": 0.32407325506210327}], "9": [{"move": "C2", "winrate": 0.6717888712882996}, {"move": "C5", "winrate": 0.6714140772819519}], "10": [{"move": "B5", "winrate": 0.38910186290740967}], "11": [{"move": "D3", "winrate": 0.6815259754657745}], "12": [{"move": "D9", "winrate": 0.3243509531021118}, {"move": "C17", "winrate": 0.3247836232185364}], "13": [{"move": "C8", "winrate": 0.755869135260582}], "14": [{"move": "A2", "winrate": 0.30344581604003906}], "15": [{"move": "B1", "winrate": 0.7211874425411224}, {"move": "E6", "winrate": 0.7192849814891815}], "16": [{"move": "C2", "winrate": 0.38549673557281494}], "17": [{"move": "F5", "winrate": 0.7650469839572906}, {"move": "F6", "winrate": 0.7677806317806244}], "18": [{"move": "E5", "winrate": 0.30726271867752075}], "19": [{"move": "Q5", "winrate": 0.7893470674753189}, {"move": "Q4", "winrate": 0.787911519408226}], "20": [{"move": "H5", "winrate": 0.43763142824172974}, {"move": "L4", "winrate": 0.43914467096328735}], "21": [{"move": "Q4", "winrate": 0.6927327215671539}, {"move": "J4", "winrate": 0.6909737586975098}, {"move": "K3", "winrate": 0.6934941411018372}], "22": [{"move": "B1", "winrate": 0.3839946389198303}], "23": [{"move": "J4", "winrate": 0.6635035276412964}], "24": [{"move": "J4", "winrate": 0.3843529224395752}], "25": [{"move": "H2", "winrate": 0.668002188205719}], "26": [{"move": "L5", "winrate": 0.4459485411643982}, {"move": "H5", "winrate": 0.44103461503982544}], "27": [{"move": "F7", "winrate": 0.9774593655019999}, {"move": "O3", "winrate": 0.9789408929646015}, {"move": "H5", "winrate": 0.9747783169150352}, {"move": "G8", "winrate": 0.9783356338739395}, {"move": "N3", "winrate": 0.9754487816244364}, {"move": "N4", "winrate": 0.9741683136671782}, {"move": "G9", "winrate": 0.976823978126049}, {"move": "G6", "winrate": 0.9755361415445805}], "28": [{"move": "H7", "winrate": 0.03178435564041138}, {"move": "K6", "winrate": 0.030442476272583008}, {"move": "H5", "winrate": 0.031530678272247314}, {"move": "J7", "winrate": 0.02992480993270874}, {"move": "L5", "winrate": 0.030099213123321533}, {"move": "J6", "winrate": 0.029452860355377197}, {"move": "N4", "winrate": 0.02703016996383667}, {"move": "H8", "winrate": 0.027601778507232666}, {"move": "J8", "winrate": 0.02849644422531128}, {"move": "K7", "winrate": 0.028658628463745117}, {"move": "K5", "winrate": 0.027527153491973877}, {"move": "Q6", "winrate": 0.02971327304840088}, {"move": "L6", "winrate": 0.028646230697631836}, {"move": "L7", "winrate": 0.028090298175811768}, {"move": "K8", "winrate": 0.027777373790740967}, {"move": "J9", "winrate": 0.030206263065338135}, {"move": "F17", "winrate": 0.02935713529586792}, {"move": "R6", "winrate": 0.028187572956085205}, {"move": "H9", "winrate": 0.02829676866531372}, {"move": "O17", "winrate": 0.027337729930877686}, {"move": "D11", "winrate": 0.028318941593170166}, {"move": "M6", "winrate": 0.029936134815216064}, {"move": "Q8", "winrate": 0.02700752019882202}, {"move": "Q9", "winrate": 0.02701866626739502}, {"move": "R14", "winrate": 0.02711808681488037}, {"move": "Q7", "winrate": 0.026983022689819336}, {"move": "D12", "winrate": 0.027743101119995117}, {"move": "D10", "winrate": 0.030037641525268555}, {"move": "F16", "winrate": 0.02727895975112915}, {"move": "R9", "winrate": 0.027181625366210938}, {"move": "H10", "winrate": 0.026795506477355957}, {"move": "R7", "winrate": 0.027497947216033936}, {"move": "R8", "winrate": 0.02711266279220581}, {"move": "N5", "winrate": 0.028520166873931885}, {"move": "D9", "winrate": 0.029691874980926514}, {"move": "R10", "winrate": 0.02695852518081665}, {"move": "N6", "winrate": 0.027735114097595215}], "29": [{"move": "O3", "winrate": 0.9837798718363047}, {"move": "L6", "winrate": 0.9815622661262751}, {"move": "G9", "winrate": 0.9827797282487154}, {"move": "H5", "winrate": 0.9801517706364393}, {"move": "O4", "winrate": 0.9803963415324688}, {"move": "N3", "winrate": 0.9813133180141449}, {"move": "R17", "winrate": 0.9788664728403091}, {"move": "N4", "winrate": 0.9796068705618382}, {"move": "F17", "winrate": 0.9795200284570456}, {"move": "Q6", "winrate": 0.9793132916092873}, {"move": "P2", "winrate": 0.980179188773036}, {"move": "O2", "winrate": 0.9788002725690603}], "30": [{"move": "L6", "winrate": 0.025734543800354004}, {"move": "M6", "winrate": 0.02570587396621704}, {"move": "L7", "winrate": 0.02633070945739746}, {"move": "M7", "winrate": 0.028809309005737305}, {"move": "H10", "winrate": 0.02879202365875244}, {"move": "J10", "winrate": 0.028171956539154053}, {"move": "N6", "winrate": 0.029542088508605957}, {"move": "K9", "winrate": 0.027021706104278564}, {"move": "F17", "winrate": 0.027356445789337158}, {"move": "Q7", "winrate": 0.025985419750213623}, {"move": "N7", "winrate": 0.027196288108825684}, {"move": "Q8", "winrate": 0.027816474437713623}, {"move": "K8", "winrate": 0.026467561721801758}, {"move": "H11", "winrate": 0.026987195014953613}, {"move": "D12", "winrate": 0.025117099285125732}, {"move": "Q9", "winrate": 0.02767360210418701}, {"move": "D9", "winrate": 0.027546226978302002}, {"move": "G10", "winrate": 0.027841150760650635}, {"move": "K10", "winrate": 0.025469422340393066}, {"move": "J11", "winrate": 0.02640146017074585}, {"move": "M8", "winrate": 0.027415096759796143}, {"move": "L8", "winrate": 0.02693617343902588}, {"move": "Q10", "winrate": 0.02813512086868286}, {"move": "O17", "winrate": 0.02700561285018921}, {"move": "L9", "winrate": 0.026306986808776855}, {"move": "R14", "winrate": 0.02768486738204956}, {"move": "R7", "winrate": 0.025380313396453857}, {"move": "O6", "winrate": 0.024631142616271973}, {"move": "R9", "winrate": 0.027075588703155518}, {"move": "O5", "winrate": 0.027276158332824707}, {"move": "F16", "winrate": 0.027519524097442627}, {"move": "R8", "winrate": 0.027092814445495605}, {"move": "N8", "winrate": 0.02637636661529541}, {"move": "M9", "winrate": 0.026307880878448486}, {"move": "K11", "winrate": 0.02519446611404419}, {"move": "H12", "winrate": 0.02580195665359497}, {"move": "J12", "winrate": 0.025669455528259277}, {"move": "R10", "winrate": 0.02740180492401123}, {"move": "O7", "winrate": 0.02456766366958618}, {"move": "R13", "winrate": 0.027319252490997314}, {"move": "L10", "winrate": 0.025114595890045166}, {"move": "G11", "winrate": 0.02585965394973755}, {"move": "Q11", "winrate": 0.02602839469909668}, {"move": "O8", "winrate": 0.0254971981048584}, {"move": "O16", "winrate": 0.02511882781982422}, {"move": "P8", "winrate": 0.025032103061676025}, {"move": "N9", "winrate": 0.025515079498291016}, {"move": "N17", "winrate": 0.025067567825317383}, {"move": "R11", "winrate": 0.026782333850860596}, {"move": "K12", "winrate": 0.02460414171218872}, {"move": "G12", "winrate": 0.02523130178451538}, {"move": "M10", "winrate": 0.025012433528900146}, {"move": "E10", "winrate": 0.02596282958984375}], "31": [{"move": "L6", "winrate": 0.9831758439540863}, {"move": "H8", "winrate": 0.9812088795006275}, {"move": "F17", "winrate": 0.9822775572538376}, {"move": "G9", "winrate": 0.9825760964304209}, {"move": "H5", "winrate": 0.9811131954193115}, {"move": "R17", "winrate": 0.9811655171215534}, {"move": "Q2", "winrate": 0.9798733275383711}, {"move": "F16", "winrate": 0.9812578838318586}, {"move": "O17", "winrate": 0.9799799062311649}, {"move": "R14", "winrate": 0.9798743557184935}, {"move": "H7", "winrate": 0.9812277667224407}, {"move": "G17", "winrate": 0.9804008081555367}, {"move": "E17", "winrate": 0.9795697834342718}, {"move": "Q6", "winrate": 0.9822051543742418}, {"move": "H10", "winrate": 0.9797036703675985}, {"move": "Q17", "winrate": 0.9789406713098288}, {"move": "Q5", "winrate": 0.9784796517342329}, {"move": "M8", "winrate": 0.9787209592759609}], "32": [{"move": "J5", "winrate": 0.038603246212005615}, {"move": "H7", "winrate": 0.03671073913574219}, {"move": "R13", "winrate": 0.03870856761932373}, {"move": "J10", "winrate": 0.03641176223754883}, {"move": "K9", "winrate": 0.03599727153778076}, {"move": "O16", "winrate": 0.0391659140586853}, {"move": "K10", "winrate": 0.03697007894515991}, {"move": "Q13", "winrate": 0.04019349813461304}, {"move": "N16", "winrate": 0.036453068256378174}, {"move": "J11", "winrate": 0.03653007745742798}, {"move": "Q14", "winrate": 0.03952205181121826}, {"move": "L8", "winrate": 0.0373188853263855}, {"move": "D12", "winrate": 0.03632277250289917}, {"move": "H12", "winrate": 0.035948753356933594}, {"move": "D9", "winrate": 0.03934586048126221}, {"move": "Q11", "winrate": 0.04024147987365723}, {"move": "H11", "winrate": 0.0368044376373291}, {"move": "K16", "winrate": 0.03847306966781616}, {"move": "Q10", "winrate": 0.04088324308395386}, {"move": "G16", "winrate": 0.037822842597961426}, {"move": "R12", "winrate": 0.040845513343811035}, {"move": "G17", "winrate": 0.03829926252365112}, {"move": "D11", "winrate": 0.03790867328643799}, {"move": "J16", "winrate": 0.03684127330780029}, {"move": "Q12", "winrate": 0.03643602132797241}, {"move": "R11", "winrate": 0.03708171844482422}], "33": [{"move": "J3", "winrate": 0.9689870476722717}, {"move": "G9", "winrate": 0.9660392105579376}, {"move": "F17", "winrate": 0.9691411815583706}, {"move": "H7", "winrate": 0.9644536785781384}, {"move": "R17", "winrate": 0.9661198295652866}, {"move": "G10", "winrate": 0.9652884379029274}, {"move": "F16", "winrate": 0.9679534174501896}, {"move": "H10", "winrate": 0.9681317210197449}, {"move": "O17", "winrate": 0.9651436544954777}, {"move": "R14", "winrate": 0.9653278887271881}], "34": [{"move": "K7", "winrate": 0.07414495944976807}], "35": [{"move": "G8", "winrate": 0.9630599059164524}, {"move": "J3", "winrate": 0.9621852412819862}], "36": [{"move": "D10", "winrate": 0.0714368224143982}], "37": [{"move": "G8", "winrate": 0.9905021721497178}, {"move": "G9", "winrate": 0.9894961751997471}, {"move": "G10", "winrate": 0.9909971859306097}, {"move": "Q4", "winrate": 0.9872608529403806}, {"move": "F10", "winrate": 0.9896126557141542}, {"move": "F9", "winrate": 0.9879339095205069}, {"move": "R17", "winrate": 0.9876196756958961}, {"move": "G11", "winrate": 0.9906223528087139}, {"move": "O17", "winrate": 0.988992060534656}, {"move": "Q2", "winrate": 0.9861320424824953}, {"move": "F11", "winrate": 0.9906493928283453}, {"move": "R14", "winrate": 0.9892280586063862}, {"move": "G2", "winrate": 0.9877789225429296}, {"move": "Q17", "winrate": 0.9878167761489749}, {"move": "K7", "winrate": 0.9874725937843323}, {"move": "H9", "winrate": 0.9873255901038647}, {"move": "E8", "winrate": 0.9882530709728599}, {"move": "G12", "winrate": 0.990066914819181}, {"move": "N17", "winrate": 0.987342145293951}, {"move": "Q6", "winrate": 0.9875785456970334}, {"move": "S5", "winrate": 0.9866453241556883}, {"move": "O16", "winrate": 0.9867969807237387}, {"move": "H11", "winrate": 0.9889609385281801}, {"move": "N16", "winrate": 0.9862221796065569}, {"move": "Q5", "winrate": 0.9868282862007618}, {"move": "R13", "winrate": 0.9869139892980456}, {"move": "H12", "winrate": 0.9890342652797699}, {"move": "Q14", "winrate": 0.9863842064514756}, {"move": "F12", "winrate": 0.9889134559780359}, {"move": "E10", "winrate": 0.9884087154641747}, {"move": "J13", "winrate": 0.9884403422474861}, {"move": "H13", "winrate": 0.9886341067031026}, {"move": "E11", "winrate": 0.9886227222159505}, {"move": "J12", "winrate": 0.9886444639414549}, {"move": "Q13", "winrate": 0.9862338770180941}, {"move": "L16", "winrate": 0.9861377291381359}, {"move": "K13", "winrate": 0.988131595775485}, {"move": "G13", "winrate": 0.9886535461992025}], "38": [{"move": "G2", "winrate": 0.05266690254211426}, {"move": "D10", "winrate": 0.053040266036987305}], "39": [{"move": "F2", "winrate": 0.954902645200491}, {"move": "G9", "winrate": 0.9507467374205589}], "40": [{"move": "D10", "winrate": 0.0582503080368042}, {"move": "J10", "winrate": 0.054910480976104736}, {"move": "H9", "winrate": 0.05451154708862305}, {"move": "F10", "winrate": 0.0582922101020813}], "41": [{"move": "C15", "winrate": 0.9739178530871868}], "42": [{"move": "E10", "winrate": 0.06137502193450928}, {"move": "F10", "winrate": 0.059972524642944336}], "43": [{"move": "C15", "winrate": 0.9730337224900723}], "44": [{"move": "D10", "winrate": 0.14166635274887085}], "45": [{"move": "J2", "winrate": 0.9871026445180178}, {"move": "C13", "winrate": 0.9845654079690576}, {"move": "E15", "winrate": 0.9849523743614554}], "46": [{"move": "G9", "winrate": 0.054847121238708496}, {"move": "G6", "winrate": 0.053772151470184326}, {"move": "F9", "winrate": 0.05857563018798828}, {"move": "G10", "winrate": 0.05454498529434204}, {"move": "F10", "winrate": 0.05409276485443115}], "47": [{"move": "E15", "winrate": 0.976207172498107}], "48": [{"move": "F10", "winrate": 0.04360330104827881}, {"move": "E11", "winrate": 0.03974050283432007}], "49": [{"move": "F10", "winrate": 0.9738549813628197}, {"move": "D6", "winrate": 0.9764491263777018}, {"move": "J2", "winrate": 0.9765576031059027}, {"move": "G10", "winrate": 0.9758870080113411}, {"move": "E11", "winrate": 0.9724578186869621}, {"move": "F11", "winrate": 0.9729851149022579}, {"move": "G9", "winrate": 0.9723710343241692}, {"move": "F9", "winrate": 0.9724901914596558}, {"move": "G11", "winrate": 0.9719791579991579}, {"move": "J3", "winrate": 0.9717317745089531}], "50": [{"move": "D10", "winrate": 0.04310482740402222}, {"move": "M16", "winrate": 0.04017394781112671}, {"move": "L16", "winrate": 0.04052019119262695}, {"move": "N4", "winrate": 0.040736496448516846}, {"move": "Q13", "winrate": 0.03903692960739136}, {"move": "H11", "winrate": 0.03976249694824219}, {"move": "J11", "winrate": 0.038170695304870605}, {"move": "F11", "winrate": 0.04184901714324951}], "51": [{"move": "F10", "winrate": 0.9743890054523945}, {"move": "J2", "winrate": 0.9775609225034714}, {"move": "G10", "winrate": 0.9756254982203245}, {"move": "D6", "winrate": 0.9762326944619417}, {"move": "F11", "winrate": 0.9735567104071379}, {"move": "B12", "winrate": 0.9728067573159933}, {"move": "F9", "winrate": 0.9727012142539024}, {"move": "G11", "winrate": 0.9734694547951221}], "52": [{"move": "D10", "winrate": 0.05097687244415283}, {"move": "F9", "winrate": 0.04669147729873657}, {"move": "F10", "winrate": 0.04780232906341553}], "53": [{"move": "D6", "winrate": 0.9730774573981762}], "54": [{"move": "G6", "winrate": 0.045319974422454834}, {"move": "F9", "winrate": 0.04923456907272339}, {"move": "D10", "winrate": 0.047730982303619385}, {"move": "D9", "winrate": 0.04697716236114502}, {"move": "N4", "winrate": 0.046826958656311035}, {"move": "E9", "winrate": 0.04911637306213379}, {"move": "E10", "winrate": 0.04551541805267334}], "55": [{"move": "Q18", "winrate": 0.9755608309060335}, {"move": "S15", "winrate": 0.9712107554078102}], "56": [{"move": "G6", "winrate": 0.03726649284362793}, {"move": "D10", "winrate": 0.038931429386138916}, {"move": "N4", "winrate": 0.04036223888397217}, {"move": "H10", "winrate": 0.03598755598068237}, {"move": "F10", "winrate": 0.03920358419418335}, {"move": "E10", "winrate": 0.03969544172286987}, {"move": "E9", "winrate": 0.03767037391662598}], "57": [{"move": "Q15", "winrate": 0.961287435144186}, {"move": "R14", "winrate": 0.9604530893266201}], "58": [{"move": "Q14", "winrate": 0.4009163975715637}], "59": [{"move": "Q18", "winrate": 0.7153488099575043}], "60": [{"move": "P18", "winrate": 0.400424063205719}], "61": [{"move": "R18", "winrate": 0.6848303973674774}, {"move": "R13", "winrate": 0.6843931078910828}], "62": [{"move": "O18", "winrate": 0.40285009145736694}], "63": [{"move": "O18", "winrate": 0.7367685735225677}], "64": [{"move": "R14", "winrate": 0.40240639448165894}], "65": [{"move": "O18", "winrate": 0.7085998952388763}, {"move": "D6", "winrate": 0.7063298225402832}], "66": [{"move": "O16", "winrate": 0.4800378680229187}], "67": [{"move": "O18", "winrate": 0.6955628991127014}], "68": [{"move": "O18", "winrate": 0.6140973269939423}], "69": [{"move": "O18", "winrate": 0.7724960595369339}], "70": [{"move": "G6", "winrate": 0.30550432205200195}], "71": [{"move": "M14", "winrate": 0.8221736997365952}], "72": [{"move": "O13", "winrate": 0.34333425760269165}], "73": [{"move": "O16", "winrate": 0.9424028433859348}], "74": [{"move": "O13", "winrate": 0.13101035356521606}], "75": [{"move": "O12", "winrate": 0.967635054141283}, {"move": "M14", "winrate": 0.9677331931889057}, {"move": "O13", "winrate": 0.9724260661751032}], "76": [{"move": "O13", "winrate": 0.16925525665283203}], "77": [{"move": "O12", "winrate": 0.9720720425248146}], "78": [{"move": "P13", "winrate": 0.6925379037857056}], "79": [{"move": "D6", "winrate": 0.4067777395248413}, {"move": "Q4", "winrate": 0.40723931789398193}], "80": [{"move": "O13", "winrate": 0.6654613614082336}], "81": [{"move": "O13", "winrate": 0.7846815288066864}], "82": [{"move": "L6", "winrate": 0.37007248401641846}], "83": [{"move": "O11", "winrate": 0.7742138504981995}], "84": [{"move": "L6", "winrate": 0.36336201429367065}], "85": [{"move": "L16", "winrate": 0.77460777759552}, {"move": "O11", "winrate": 0.7780711501836777}], "86": [{"move": "H17", "winrate": 0.5626412332057953}], "87": [{"move": "O11", "winrate": 0.5611937940120697}], "88": [{"move": "H17", "winrate": 0.5398603677749634}, {"move": "L15", "winrate": 0.5424090921878815}], "89": [{"move": "L14", "winrate": 0.5100825428962708}], "90": [{"move": "K14", "winrate": 0.5543560087680817}], "91": [{"move": "J15", "winrate": 0.49246281385421753}], "92": [{"move": "K13", "winrate": 0.8045003265142441}], "93": [{"move": "J15", "winrate": 0.22290146350860596}], "94": [{"move": "K11", "winrate": 0.8745016753673553}, {"move": "F9", "winrate": 0.8730196505784988}], "95": [{"move": "J15", "winrate": 0.21738415956497192}], "96": [{"move": "K11", "winrate": 0.8792749345302582}], "97": [{"move": "K11", "winrate": 0.42752087116241455}], "98": [{"move": "K11", "winrate": 0.8302111625671387}], "99": [{"move": "E16", "winrate": 0.25405943393707275}], "100": [{"move": "E16", "winrate": 0.8924635276198387}, {"move": "M15", "winrate": 0.8910098001360893}], "101": [{"move": "E17", "winrate": 0.2595701217651367}], "102": [{"move": "M15", "winrate": 0.8835684135556221}], "103": [{"move": "M15", "winrate": 0.6248075366020203}], "104": [{"move": "O13", "winrate": 0.9832274224609137}], "105": [{"move": "L12", "winrate": 0.03868001699447632}, {"move": "M18", "winrate": 0.037668824195861816}], "106": [{"move": "L12", "winrate": 0.9886946873739362}], "107": [{"move": "F12", "winrate": 0.031808435916900635}, {"move": "G12", "winrate": 0.03135961294174194}, {"move": "H12", "winrate": 0.03333461284637451}, {"move": "G13", "winrate": 0.03155630826950073}], "108": [{"move": "H12", "winrate": 0.9877523984760046}, {"move": "L12", "winrate": 0.988665159791708}], "109": [{"move": "F12", "winrate": 0.022615134716033936}, {"move": "H17", "winrate": 0.018925249576568604}], "110": [{"move": "L12", "winrate": 0.9929776526987553}, {"move": "K11", "winrate": 0.9930451288819313}, {"move": "J11", "winrate": 0.9913359684869647}, {"move": "J12", "winrate": 0.9897315641865134}, {"move": "G11", "winrate": 0.9904981553554535}, {"move": "G18", "winrate": 0.988437732681632}], "111": [{"move": "F12", "winrate": 0.031177222728729248}], "112": [{"move": "E12", "winrate": 0.9970483994111419}, {"move": "L12", "winrate": 0.9942787112668157}, {"move": "K11", "winrate": 0.9947378248907626}, {"move": "D12", "winrate": 0.992607110645622}, {"move": "J12", "winrate": 0.9930282272398472}, {"move": "J11", "winrate": 0.9928710451349616}], "113": [{"move": "F11", "winrate": 0.014117956161499023}], "114": [{"move": "F11", "winrate": 0.9927776772528887}, {"move": "L12", "winrate": 0.9932950814254582}, {"move": "K11", "winrate": 0.993070850148797}], "115": [{"move": "G11", "winrate": 0.00674813985824585}, {"move": "E12", "winrate": 0.005336165428161621}, {"move": "J12", "winrate": 0.004879772663116455}, {"move": "H17", "winrate": 0.009230077266693115}, {"move": "E11", "winrate": 0.009619951248168945}], "116": [{"move": "E11", "winrate": 0.9963623171206564}, {"move": "L12", "winrate": 0.9949715831317008}, {"move": "K11", "winrate": 0.9959074798971415}, {"move": "D11", "winrate": 0.9930122247897089}, {"move": "J12", "winrate": 0.9914153469726443}, {"move": "J11", "winrate": 0.9926759754307568}], "117": [{"move": "J12", "winrate": 0.006021618843078613}, {"move": "D11", "winrate": 0.005185842514038086}, {"move": "L12", "winrate": 0.005778372287750244}, {"move": "G11", "winrate": 0.006853640079498291}, {"move": "H17", "winrate": 0.006398499011993408}, {"move": "L11", "winrate": 0.007067322731018066}, {"move": "K11", "winrate": 0.008909940719604492}], "118": [{"move": "D11", "winrate": 0.9985208158614114}, {"move": "L12", "winrate": 0.9966884437017143}, {"move": "K11", "winrate": 0.9976325526367873}, {"move": "J18", "winrate": 0.9968318231403828}], "119": [{"move": "H7", "winrate": 0.010125041007995605}, {"move": "M18", "winrate": 0.011679112911224365}, {"move": "L18", "winrate": 0.01100069284439087}, {"move": "D6", "winrate": 0.011814355850219727}, {"move": "J9", "winrate": 0.006975293159484863}, {"move": "H8", "winrate": 0.008331537246704102}], "120": [{"move": "D11", "winrate": 0.9990326257538982}, {"move": "L12", "winrate": 0.9976442125625908}, {"move": "C10", "winrate": 0.9983675576513633}, {"move": "M10", "winrate": 0.998128047795035}], "121": [{"move": "D11", "winrate": 0.0033583641052246094}, {"move": "L12", "winrate": 0.0067198872566223145}, {"move": "M11", "winrate": 0.004846334457397461}, {"move": "M18", "winrate": 0.008244633674621582}, {"move": "H7", "winrate": 0.005923271179199219}, {"move": "L18", "winrate": 0.006867706775665283}], "122": [{"move": "M11", "winrate": 0.995885968208313}, {"move": "D11", "winrate": 0.9978336521890014}, {"move": "M10", "winrate": 0.9965080907568336}, {"move": "L10", "winrate": 0.997161079896614}], "123": [{"move": "K12", "winrate": 0.008997201919555664}, {"move": "K11", "winrate": 0.011004209518432617}, {"move": "M18", "winrate": 0.010459363460540771}], "124": [{"move": "O11", "winrate": 0.9946374357677996}, {"move": "N10", "winrate": 0.9919338570907712}, {"move": "D11", "winrate": 0.9955753334797919}], "125": [{"move": "K11", "winrate": 0.007863998413085938}, {"move": "L18", "winrate": 0.012076079845428467}, {"move": "S12", "winrate": 0.009359240531921387}], "126": [{"move": "M18", "winrate": 0.9970353934913874}, {"move": "L18", "winrate": 0.9970547179691494}, {"move": "N18", "winrate": 0.9973554369062185}, {"move": "D11", "winrate": 0.9931000033393502}, {"move": "K19", "winrate": 0.9972711056470871}], "127": [{"move": "K12", "winrate": 0.010615646839141846}, {"move": "K11", "winrate": 0.011559247970581055}, {"move": "N11", "winrate": 0.010046005249023438}], "128": [{"move": "O19", "winrate": 0.9991998695768416}, {"move": "D11", "winrate": 0.9948786804452538}, {"move": "M18", "winrate": 0.998527936055325}, {"move": "J18", "winrate": 0.9973983231466264}], "129": [{"move": "D11", "winrate": 0.0017657279968261719}, {"move": "K12", "winrate": 0.0016992688179016113}, {"move": "M18", "winrate": 0.0040035247802734375}, {"move": "K11", "winrate": 0.0016210079193115234}, {"move": "H7", "winrate": 0.0017445683479309082}, {"move": "N11", "winrate": 0.0010973215103149414}, {"move": "L18", "winrate": 0.001985311508178711}, {"move": "N17", "winrate": 0.0050196051597595215}, {"move": "J7", "winrate": 0.0014965534210205078}, {"move": "D6", "winrate": 0.001237630844116211}, {"move": "J9", "winrate": 0.001239180564880371}], "130": [{"move": "D11", "winrate": 0.9996925771702081}, {"move": "C10", "winrate": 0.9995933959435206}, {"move": "D10", "winrate": 0.9995185938023496}], "131": [{"move": "D11", "winrate": 0.001192927360534668}, {"move": "K12", "winrate": 0.0014290809631347656}, {"move": "K11", "winrate": 0.00157088041305542}, {"move": "H7", "winrate": 0.001640021800994873}, {"move": "N11", "winrate": 0.001018822193145752}, {"move": "D6", "winrate": 0.0012717843055725098}, {"move": "J7", "winrate": 0.0014359354972839355}, {"move": "S12", "winrate": 0.000578761100769043}, {"move": "J9", "winrate": 0.0011696219444274902}, {"move": "K9", "winrate": 0.0011566877365112305}], "132": [{"move": "D11", "winrate": 0.9996481715643313}, {"move": "C10", "winrate": 0.9994578585028648}, {"move": "D10", "winrate": 0.9993957230472006}], "133": [{"move": "D11", "winrate": 0.0010637640953063965}, {"move": "K12", "winrate": 0.001960575580596924}, {"move": "K11", "winrate": 0.0023019909858703613}, {"move": "N11", "winrate": 0.0017213821411132812}, {"move": "H7", "winrate": 0.001701056957244873}, {"move": "S12", "winrate": 0.0012593865394592285}, {"move": "J9", "winrate": 0.001473546028137207}, {"move": "K9", "winrate": 0.0015485286712646484}, {"move": "J7", "winrate": 0.0016156435012817383}, {"move": "G11", "winrate": 0.0013505816459655762}, {"move": "D6", "winrate": 0.0012314915657043457}, {"move": "S13", "winrate": 0.002372920513153076}], "134": [{"move": "D11", "winrate": 0.9996971628861502}, {"move": "C10", "winrate": 0.9996153084211983}, {"move": "D10", "winrate": 0.9995420875202399}], "135": [{"move": "D11", "winrate": 0.0007599592208862305}, {"move": "L13", "winrate": 0.0010783672332763672}, {"move": "D6", "winrate": 0.0007278323173522949}, {"move": "H7", "winrate": 0.0011011362075805664}, {"move": "S12", "winrate": 0.0007759332656860352}, {"move": "K11", "winrate": 0.0011255145072937012}, {"move": "N11", "winrate": 0.0011332035064697266}, {"move": "J7", "winrate": 0.0010306835174560547}], "136": [{"move": "K11", "winrate": 0.9996255982841831}, {"move": "D11", "winrate": 0.9980831479188055}, {"move": "N11", "winrate": 0.9995535393245518}, {"move": "K12", "winrate": 0.9995406231610104}, {"move": "K10", "winrate": 0.9994884572806768}], "137": [{"move": "D11", "winrate": 0.0006775856018066406}, {"move": "K12", "winrate": 0.001328587532043457}, {"move": "G11", "winrate": 0.0013719797134399414}, {"move": "K11", "winrate": 0.0020467042922973633}, {"move": "J9", "winrate": 0.0011038780212402344}, {"move": "H7", "winrate": 0.0010032057762145996}, {"move": "K9", "winrate": 0.0016155242919921875}, {"move": "J10", "winrate": 0.002171456813812256}, {"move": "J7", "winrate": 0.0008919835090637207}, {"move": "K10", "winrate": 0.0019094347953796387}], "138": [{"move": "D11", "winrate": 0.9973168701399118}, {"move": "J18", "winrate": 0.999315922963433}, {"move": "L17", "winrate": 0.9997524607460946}, {"move": "K19", "winrate": 0.9997758881218033}, {"move": "G18", "winrate": 0.9964515939354897}], "139": [{"move": "D11", "winrate": 0.0010767579078674316}, {"move": "K19", "winrate": 0.0008546113967895508}, {"move": "K12", "winrate": 0.001018822193145752}, {"move": "K11", "winrate": 0.0013568997383117676}, {"move": "G11", "winrate": 0.0014850497245788574}, {"move": "J9", "winrate": 0.0010373592376708984}, {"move": "G18", "winrate": 0.0011225342750549316}, {"move": "J10", "winrate": 0.0012362003326416016}, {"move": "H7", "winrate": 0.0013214945793151855}, {"move": "K9", "winrate": 0.0012692809104919434}, {"move": "K10", "winrate": 0.0013520121574401855}, {"move": "M15", "winrate": 0.0016952753067016602}], "140": [{"move": "D11", "winrate": 0.9998340612510219}, {"move": "K19", "winrate": 0.9998939368815627}, {"move": "C10", "winrate": 0.9997177141485736}], "141": [{"move": "D11", "winrate": 0.0005561709403991699}, {"move": "K11", "winrate": 0.0006712675094604492}, {"move": "K12", "winrate": 0.0003529787063598633}, {"move": "H7", "winrate": 0.0009605288505554199}, {"move": "D6", "winrate": 0.0004684925079345703}, {"move": "J9", "winrate": 0.0007609128952026367}, {"move": "G11", "winrate": 0.0006584525108337402}, {"move": "J7", "winrate": 0.0007993578910827637}, {"move": "J10", "winrate": 0.0007237792015075684}, {"move": "K10", "winrate": 0.0006502270698547363}, {"move": "K9", "winrate": 0.0007372498512268066}]};
let player = new WGo.SimplePlayer(document.getElementById('board'), { sgf: SGF });
let currentMove = 0;
let labels = {};  // move index -> tag mapping
let selectedSpatial = null;

// Try to sync with WGo.js player state changes
function syncPlayerState() {
  // Calculate current move from player state
  let moveCount = 0;
  if(player.currentNode && player.rootNode) {
    let node = player.rootNode;
    while(node !== player.currentNode && node.children && node.children.length > 0) {
      moveCount++;
      node = node.children[0];
    }
  }
  
  // Only update if move actually changed
  if(moveCount !== currentMove) {
    console.log('Move changed from', currentMove, 'to', moveCount);
    currentMove = moveCount;
    
    // Update our custom UI
    updateMoveDisplay();
    renderForm();
    renderPolicy();
    
    // Delay marker rendering to let WGo.js finish updating
    setTimeout(() => {
      renderMarkers();
    }, 10);
  }
}

// Check for player state changes periodically
setInterval(syncPlayerState, 100);

// Also try to hook into WGo.js events if available
if(player.on && typeof player.on === 'function') {
  console.log('Using player.on for events');
  player.on('update', syncPlayerState);
  player.on('change', syncPlayerState);
} else if(player.addEventListener && typeof player.addEventListener === 'function') {
  console.log('Using player.addEventListener for events');
  player.addEventListener('update', syncPlayerState);
  player.addEventListener('change', syncPlayerState);
} else {
  console.log('Using polling method for player state sync');
}

// Extract game info from SGF
function initGameInfo() {
  try {
    let sgfRoot = null;
    
    // Try different ways to access SGF info - WGo SimplePlayer structure
    if(player.rootNode && player.rootNode.properties) {
      sgfRoot = player.rootNode.properties;
    } else if(player.game && player.game.root && player.game.root.properties) {
      sgfRoot = player.game.root.properties;
    } else if(player.rootNode) {
      sgfRoot = player.rootNode;
    } else {
      console.log('Could not find SGF root info, using defaults');
    }
    
    console.log('SGF Root found:', sgfRoot);
    
    // Extract player names - try multiple formats
    let blackPlayer = 'Black';
    let whitePlayer = 'White';
    let gameDate = '';
    let result = '';
    
    if(sgfRoot) {
      // Try array format first [SGF standard]
      if(sgfRoot.PB && Array.isArray(sgfRoot.PB)) blackPlayer = sgfRoot.PB[0];
      else if(sgfRoot.PB) blackPlayer = sgfRoot.PB;
      
      if(sgfRoot.PW && Array.isArray(sgfRoot.PW)) whitePlayer = sgfRoot.PW[0];
      else if(sgfRoot.PW) whitePlayer = sgfRoot.PW;
      
      if(sgfRoot.DT && Array.isArray(sgfRoot.DT)) gameDate = sgfRoot.DT[0];
      else if(sgfRoot.DT) gameDate = sgfRoot.DT;
      
      if(sgfRoot.RE && Array.isArray(sgfRoot.RE)) result = sgfRoot.RE[0];
      else if(sgfRoot.RE) result = sgfRoot.RE;
    }
    
    // Fallback: extract from raw SGF string if properties didn't work
    if(blackPlayer === 'Black' || whitePlayer === 'White') {
      const pbMatch = SGF.match(/PB\[([^\]]*)\]/);
      const pwMatch = SGF.match(/PW\[([^\]]*)\]/);
      if(pbMatch && pbMatch[1]) blackPlayer = pbMatch[1];
      if(pwMatch && pwMatch[1]) whitePlayer = pwMatch[1];
    }
    
    console.log('Final extracted names:', blackPlayer, whitePlayer);
    
    document.getElementById('black-player').textContent = blackPlayer || 'Black';
    document.getElementById('white-player').textContent = whitePlayer || 'White';
    document.getElementById('game-info').textContent = gameDate + (result ? ' • ' + result : '');
  } catch(e) {
    console.error('Error initializing game info:', e);
    document.getElementById('black-player').textContent = 'Black';
    document.getElementById('white-player').textContent = 'White';
    document.getElementById('game-info').textContent = 'Game loaded';
  }
}

function renderForm() {
  const form = document.getElementById('tag_form');
  form.innerHTML = '';
  form.innerHTML += '<h3>Global tags</h3>';
  GLOBAL_TAGS.forEach(tag => {
    const checked = labels[currentMove] && labels[currentMove][tag] ? 'checked' : '';
    form.innerHTML += `<div class="tag-block"><label><input type="checkbox" data-tag="${tag}" ${checked}/> ${tag}</label></div>`;
  });
  form.innerHTML += '<h3>Spatial tags</h3>';
  SPATIAL_TAGS.forEach(tag => {
    const pts = (labels[currentMove] && labels[currentMove][tag]) || [];
    const checked = selectedSpatial === tag ? 'checked' : '';
    form.innerHTML += `<div class="tag-block"><label><input type="radio" name="spatial" value="${tag}" ${checked}/> ${tag}</label> <span id="${tag}_pts">${pts.map(p => '(' + p[0] + ',' + p[1] + ')').join(' ')}</span></div>`;
  });
}

function renderMarkers() {
  // Access board through SimplePlayer structure - try multiple ways
  let board = null;
  
  console.log('=== RENDER MARKERS DEBUG ===');
  
  // Try different ways to access the board
  if(player.components && player.components.get) {
    // components is a Map, get the board container
    const boardElement = document.getElementById('board');
    const container = player.components.get(boardElement);
    console.log('Board from components Map:', container);
    
    // Based on the structure we can see, try to get SVGBoardComponent directly
    if(container && container.children && container.children[1] && container.children[1].children) {
      const svgBoardComponent = container.children[1].children[0];
      console.log('Direct access to SVGBoardComponent:', svgBoardComponent);
      if(svgBoardComponent && svgBoardComponent.board) {
        console.log('Direct access to SVGBoard:', svgBoardComponent.board);
        board = svgBoardComponent.board;
      }
    }
    
    if(!board) {
      board = container;
    }
  }
  
  if(!board && player.board) {
    board = player.board;
    console.log('Board from player.board:', board);
  }
  
  if(!board && player.components && player.components.board) {
    board = player.components.board;
    console.log('Board from player.components.board:', board);
  }
  
  console.log('Final board object:', board);
  console.log('Board methods available:', board ? Object.getOwnPropertyNames(board) : 'No board');
  
  // If we found a Container, search through its children for the board component
  if(board && board.children && Array.isArray(board.children)) {
    console.log('Container children:', board.children);
    
    // Look for a child that has board methods
    for(let child of board.children) {
      console.log('Checking child:', child);
      console.log('Child methods:', child ? Object.getOwnPropertyNames(child) : 'No child');
      
      if(child && child.removeAllObjects) {
        console.log('Found board in child:', child);
        board = child;
        break;
      }
      
      // Also check if child has a board property
      if(child && child.board && child.board.removeAllObjects) {
        console.log('Found board in child.board:', child.board);
        board = child.board;
        break;
      }
      
      // Check if this is a ResponsiveComponent with a component property
      if(child && child.component) {
        console.log('Checking child.component:', child.component);
        if(child.component.removeAllObjects) {
          console.log('Found board in child.component:', child.component);
          board = child.component;
          break;
        }
        
        // If component is a Container, check its children too
        if(child.component.children && Array.isArray(child.component.children)) {
          console.log('Checking nested container children:', child.component.children);
          for(let nestedChild of child.component.children) {
            console.log('Nested child:', nestedChild);
            console.log('Nested child type:', nestedChild.constructor.name);
            
            if(nestedChild && nestedChild.removeAllObjects) {
              console.log('Found board in nested child:', nestedChild);
              board = nestedChild;
              break;
            }
            
            // Check for SVGBoardComponent which has a board property
            if(nestedChild && nestedChild.constructor && nestedChild.constructor.name === 'SVGBoardComponent') {
              console.log('Found SVGBoardComponent, checking its board property:', nestedChild.board);
              if(nestedChild.board) {
                console.log('SVGBoard object:', nestedChild.board);
                console.log('SVGBoard methods:', Object.getOwnPropertyNames(nestedChild.board));
                board = nestedChild.board;
                break;
              }
            }
            
            // Also check nested child's board property
            if(nestedChild && nestedChild.board && nestedChild.board.removeAllObjects) {
              console.log('Found board in nested child.board:', nestedChild.board);
              board = nestedChild.board;
              break;
            }
          }
          if(board && board.removeAllObjects) break; // Exit outer loop if found
        }
      }
    }
  }
  
  // If we found a Container, try to access its board
  if(board && !board.removeAllObjects && board.board) {
    console.log('Trying board.board:', board.board);
    board = board.board;
  }
  
  // Also try accessing through getBoard method if it exists
  if(board && !board.removeAllObjects && board.getBoard) {
    console.log('Trying board.getBoard():', board.getBoard());
    board = board.getBoard();
  }
  
  // If we still haven't found the board, do a recursive search
  if(!board || !board.removeAllObjects) {
    console.log('Board not found yet, doing recursive search...');
    
    function findBoardRecursively(obj, path = '') {
      if(!obj) return null;
      
      // Check if this object is the board we want
      if(obj.removeAllObjects && obj.addObject) {
        console.log('Found board at path:', path, obj);
        return obj;
      }
      
      // Check if this is SVGBoardComponent
      if(obj.constructor && obj.constructor.name === 'SVGBoardComponent') {
        console.log('Found SVGBoardComponent at path:', path, obj);
        if(obj.board && obj.board.removeAllObjects) {
          console.log('Found board in SVGBoardComponent.board:', obj.board);
          return obj.board;
        }
      }
      
      // Recursively search common properties
      const propsToSearch = ['board', 'component', 'children', 'components'];
      for(let prop of propsToSearch) {
        if(obj[prop]) {
          if(Array.isArray(obj[prop])) {
            for(let i = 0; i < obj[prop].length; i++) {
              const result = findBoardRecursively(obj[prop][i], path + '.' + prop + '[' + i + ']');
              if(result) return result;
            }
          } else {
            const result = findBoardRecursively(obj[prop], path + '.' + prop);
            if(result) return result;
          }
        }
      }
      
      return null;
    }
    
    const foundBoard = findBoardRecursively(player, 'player');
    if(foundBoard) {
      board = foundBoard;
      console.log('Recursively found board:', board);
    }
  }
  
  console.log('Final resolved board:', board);
  if(board) {
    console.log('Board methods:', Object.getOwnPropertyNames(board));
    console.log('Board config:', board.config);
    console.log('Board size/dimensions:', { width: board.width, height: board.height, size: board.size });
    console.log('Existing board objects:', board.objects);
    
    // Check if there are existing objects and their coordinate format
    if(board.objects && board.objects.length > 0) {
      console.log('Sample existing object:', board.objects[0]);
      console.log('Existing object coordinates:', { x: board.objects[0].x, y: board.objects[0].y });
    }
  }
  
  if(board && board.objects) {
    // Remove only our custom objects (AI labels and user tags), keep game stones
    const objectsToRemove = board.objects.filter(obj => 
      obj.type === 'LB' || obj.type === 'MA' || obj.type === 'CR' || obj.type === 'SQ'
    );
    objectsToRemove.forEach(obj => board.removeObject(obj));
    
    console.log('Removed', objectsToRemove.length, 'custom objects, keeping game stones');
    
    // Render user tags
    const tags = labels[currentMove] || {};
    Object.keys(tags).forEach(tag => {
      const pts = tags[tag];
      if(Array.isArray(pts)) {
        pts.forEach(pt => board.addObject({ x: pt[0], y: pt[1], type: 'MA' }));
      }
    });
    
         // Render policy suggestions for the position that was just played (not the upcoming move)
     // Show suggestions for the previous move (what AI suggested before this move was played)
     const policyMoves = currentMove > 0 ? (POLICY[currentMove - 1] || []) : [];
     console.log('Rendering', policyMoves.length, 'policy moves for position', currentMove > 0 ? currentMove - 1 : 'none');
    
    if(policyMoves.length > 0) {
      const playerToMove = currentMove % 2 === 0 ? 'black' : 'white';
      console.log('Player to move:', playerToMove);
      
      policyMoves.forEach((move, index) => {
        const coord = sgfToCoord(move.move);
        
        if(coord && typeof coord.x === 'number' && typeof coord.y === 'number' && 
           coord.x >= 0 && coord.x < 19 && coord.y >= 0 && coord.y < 19) {
          try {
            
            // Add policy move marker with red styling
            const winrateText = (move.winrate * 100).toFixed(0);
            console.log('Adding policy label at:', coord.x, coord.y, 'with text:', winrateText);
            
            // Create label object
            const labelObj = new WGo.LabelBoardObject(winrateText, coord.x, coord.y);
            
            // Mark this as a policy label so we can style it differently
            labelObj.isPolicyLabel = true;
            
            board.addObject(labelObj);
            
                         // Apply red styling after the object is added to the DOM
             setTimeout(() => {
               const boardElement = document.getElementById('board');
               const textElements = boardElement.querySelectorAll('text');
               textElements.forEach(textEl => {
                 // Only style text elements that contain our winrate numbers
                 if(textEl.textContent === winrateText) {
                   textEl.style.fill = 'red';
                   textEl.style.fontWeight = 'bold';
                   textEl.style.fontSize = '10px';
                   textEl.classList.add('policy-label');
                 }
               });
             }, 50);
            
            console.log('Successfully added red label at', coord.x, coord.y);
            

            
            console.log('Added policy move at', coord.x, coord.y, 'with winrate', winrateText + '%');
          } catch(e) {
            console.error('Error adding board object:', e);
            console.error('Board object at error:', board);
            console.error('Board addObject method:', typeof board.addObject);
          }
        } else {
          console.error('Invalid coordinates for move:', move.move, coord);
        }
      });
    } else {
      console.log('No policy moves to render for position', currentMove);
    }
    
    // Refresh only the objects layer, not the entire board
    if(board && board.redraw) {
      console.log('Calling board.redraw() to refresh custom objects');
      board.redraw();
    }
    
    console.log('Total objects on board after rendering:', board.objects.length);
    console.log('Objects:', board.objects.map(obj => obj.type || 'unknown'));
  } else {
    console.error('Board object not found or missing removeAllObjects method');
    console.error('Player structure:', player);
  }
}

function sgfToCoord(moveString) {
  if(!moveString || moveString === 'pass') {
    console.log('Skipping move:', moveString);
    return null;
  }
  
  console.log('Converting move string:', moveString);
  
  // Handle SGF coordinates like 'pd', 'dp', etc. (lowercase letters)
  if(moveString.length === 2 && /^[a-s][a-s]$/.test(moveString)) {
    const x = moveString.charCodeAt(0) - 'a'.charCodeAt(0);
    const y = moveString.charCodeAt(1) - 'a'.charCodeAt(0);
    console.log(`SGF format ${moveString}: x=${x}, y=${y}`);
    return { x: x, y: y };
  }
  
  // Handle human coordinates like 'C16', 'D4', 'P16', etc.
  const match = moveString.match(/^([A-HJ-T])(\d+)$/);
  if(match) {
    const letter = match[1];
    const number = parseInt(match[2], 10);
    
    // Convert letter to x coordinate (A=0, B=1, ..., H=7, J=8, ..., T=18)
    let x = letter.charCodeAt(0) - 'A'.charCodeAt(0);
    if(x >= 8) x--; // Skip 'I' in Go notation
    
    // Convert number to y coordinate (1=18, 2=17, ..., 19=0)
    const y = 19 - number;
    
    console.log(`Human format ${moveString}: letter=${letter}, number=${number}, x=${x}, y=${y}`);
    
    // Validate the coordinates
    if(isNaN(x) || isNaN(y) || x < 0 || x >= 19 || y < 0 || y >= 19) {
      console.error(`Invalid coordinates generated: x=${x}, y=${y} from ${moveString}`);
      return null;
    }
    
    return { x: x, y: y };
  }
  
  console.error('Failed to parse move:', moveString);
  return null;
}

  function renderPolicy() {
    const div = document.getElementById('policy_suggestions');
    // Show policy suggestions for the position that was just played (not the upcoming move)
    const opts = currentMove > 0 ? (POLICY[currentMove - 1] || []) : [];
    
    console.log('Current move:', currentMove, 'Policy data for position:', currentMove > 0 ? currentMove - 1 : 'none', opts);
  
     if(currentMove === 0) {
     div.innerHTML = '<em>No move played yet</em>';
     return;
   }
   
   if(opts.length === 0) {
     div.innerHTML = '<em>No AI suggestions available for this position</em>';
     return;
   }
   
       // The player who was to move at the previous position (before current move was played)
    const playerWhoMoved = (currentMove - 1) % 2 === 0 ? 'Black' : 'White';
    const lines = opts.map(o => 
      `<div class="policy-move">${o.move}: ${(o.winrate * 100).toFixed(1)}%</div>`
    );
    // Display move number as 1-indexed (currentMove is already the human-readable move number)
    div.innerHTML = `<strong>AI suggestions for ${playerWhoMoved} at move ${currentMove}</strong><br/>${lines.join('')}`;
}

document.getElementById('tag_form').addEventListener('change', e => {
  const tag = e.target.getAttribute('data-tag');
  if(tag) {
    labels[currentMove] = labels[currentMove] || {};
    labels[currentMove][tag] = e.target.checked;
  } else if(e.target.name === 'spatial') {
    selectedSpatial = e.target.value;
  }
});

// Set up click handler for the board
const board = player.board || (player.components && player.components.board);
if(board && board.addEventListener) {
  board.addEventListener('click', (x, y) => {
    if(selectedSpatial === null) return;
    labels[currentMove] = labels[currentMove] || {};
    labels[currentMove][selectedSpatial] = labels[currentMove][selectedSpatial] || [];
    labels[currentMove][selectedSpatial].push([x, y]);
    renderForm();
    renderMarkers();
  });
}

function updateMoveDisplay() {
  document.getElementById('move_idx').textContent = currentMove;
}

function gotoMove(idx) {
  try {
    console.log('Manual navigation to move', idx, 'from current move', currentMove);
    
    if(idx < 0) {
      console.log('Move index too low');
      return;
    }
    
    // Use WGo.js navigation methods that properly maintain board state
    if(idx > currentMove) {
      // Move forward one step at a time
      for(let i = currentMove; i < idx; i++) {
        if(player.next && typeof player.next === 'function') {
          player.next();
        } else {
          break;
        }
      }
    } else if(idx < currentMove) {
      // Move backward one step at a time
      for(let i = currentMove; i > idx; i--) {
        if(player.previous && typeof player.previous === 'function') {
          player.previous();
        } else {
          break;
        }
      }
    }
    
    // The 'update' event listener will handle UI updates
    console.log('Navigation completed');
  } catch(e) {
    console.error('Error in gotoMove:', e);
  }
}

document.getElementById('next').onclick = () => gotoMove(currentMove + 1);
document.getElementById('prev').onclick = () => gotoMove(currentMove - 1);

document.getElementById('export').onclick = () => {
  const data = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(labels));
  const a = document.createElement('a');
  a.setAttribute('href', data);
  a.setAttribute('download', 'labels.json');
  a.click();
};

console.log('Player object:', player);
console.log('Player kifu:', player.kifu);
console.log('Player available methods:', Object.getOwnPropertyNames(player));
if(player.kifu) {
  console.log('Kifu structure:', Object.getOwnPropertyNames(player.kifu));
}
initGameInfo();
renderForm();
updateMoveDisplay();
renderPolicy();
renderMarkers();
</script>
</body>
</html>
