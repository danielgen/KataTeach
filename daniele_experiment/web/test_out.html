<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<title>Go Position Labeler</title>
<script src='wgo.min.js'></script>
<style>
  #board { width: 400px; margin-bottom: 10px; }
  .tag-block { margin: 5px 0; }
</style>
</head>
<body>
<div id='board'></div>
<div>
  <button id='prev'>Prev</button>
  <span id='move_idx'>0</span>
  <button id='next'>Next</button>
</div>
<form id='tag_form'></form>
<button id='export'>Export Labels</button>
<script>
const SGF = "(;FF[4]GM[1]SZ[19]PB[kata1-b28c512nbt-s8954935040-d4794564322]PW[kata1-b28c512nbt-s10154692864-d5110402032]HA[0]KM[6.5]RU[koPOSITIONALscoreTERRITORYtaxNONEsui1]RE[W+R]C[startTurnIdx=0,initTurnNum=0,gameHash=E3F4BB251CEA8A1BABD10E8DEE4E508C,gtype=normal];B[qp]C[0.53 0.47 0.00 0.4 v=600];W[dp]C[0.53 0.47 0.00 0.4 v=600];B[cd]C[0.53 0.47 0.00 0.5 v=632];W[pc]C[0.53 0.47 0.00 0.4 v=720];B[qe]C[0.52 0.48 0.00 0.3 v=614];W[ed]C[0.52 0.48 0.00 0.2 v=694];B[od]C[0.52 0.48 0.00 0.3 v=653];W[oc]C[0.52 0.48 0.00 0.3 v=658];B[nd]C[0.52 0.48 0.00 0.3 v=864];W[mc]C[0.53 0.47 0.00 0.3 v=1186];B[ec]C[0.52 0.48 0.00 0.2 v=1391];W[fc]C[0.53 0.47 0.00 0.3 v=1568];B[eb]C[0.52 0.48 0.00 0.2 v=1798];W[ce]C[0.52 0.48 0.00 0.3 v=1974];B[fd]C[0.52 0.48 0.00 0.2 v=794];W[de]C[0.52 0.48 0.00 0.2 v=841];B[bd]C[0.53 0.47 0.00 0.3 v=860];W[gc]C[0.51 0.49 0.00 0.1 v=665];B[fe]C[0.51 0.49 0.00 0.1 v=853];W[hd]C[0.51 0.49 0.00 0.1 v=1075];B[fg]C[0.51 0.49 0.00 0.0 v=1193];W[dh]C[0.51 0.49 0.00 0.1 v=1456];B[be]C[0.52 0.48 0.00 0.2 v=1074];W[cg]C[0.52 0.48 0.00 0.3 v=1204];B[he]C[0.52 0.48 0.00 0.2 v=965];W[dd]C[0.52 0.48 0.00 0.2 v=1027];B[dc]C[0.54 0.46 0.00 0.5 v=605];W[gf]C[0.53 0.47 0.00 0.4 v=997];B[ei]C[0.55 0.45 0.00 0.7 v=990];W[dj]C[0.54 0.46 0.00 0.6 v=658];B[ge]C[0.56 0.44 0.00 0.9 v=696];W[jd]C[0.52 0.48 0.00 0.2 v=724];B[ie]C[0.52 0.48 0.00 0.3 v=821];W[kd]C[0.53 0.47 0.00 0.3 v=1139];B[di]C[0.54 0.46 0.00 0.5 v=859];W[ci]C[0.54 0.46 0.00 0.6 v=1073];B[cj]C[0.56 0.44 0.00 0.8 v=1014];W[bj]C[0.55 0.45 0.00 0.8 v=1614];B[ck]C[0.58 0.42 0.00 1.3 v=1370];W[bk]C[0.57 0.43 0.00 1.0 v=1913];B[cl]C[0.58 0.42 0.00 1.3 v=1859];W[eh]C[0.57 0.43 0.00 1.1 v=2176];B[fh]C[0.58 0.42 0.00 1.3 v=1889];W[cb]C[0.57 0.43 0.00 1.1 v=2093];B[cc]C[0.58 0.42 0.00 1.4 v=1633];W[bl]C[0.57 0.43 0.00 1.2 v=1456];B[cm]C[0.59 0.41 0.00 1.6 v=2079];W[fi]C[0.57 0.43 0.00 1.1 v=1888];B[ej]C[0.59 0.41 0.00 1.5 v=2518];W[bf]C[0.56 0.44 0.00 1.0 v=2481];B[fk]C[0.59 0.41 0.00 1.5 v=3077];W[gi]C[0.55 0.45 0.00 0.9 v=2249];B[df]C[0.58 0.42 0.00 1.3 v=2435];W[cf]C[0.54 0.46 0.00 0.5 v=868];B[hh]C[0.56 0.44 0.00 1.0 v=1059];W[bb]C[0.53 0.47 0.00 0.3 v=1225];B[hi]C[0.51 0.49 0.00 -0.0 v=688];W[ab]C[0.50 0.50 0.00 -0.2 v=796];B[fq]C[0.47 0.53 0.00 -0.9 v=671];W[bm]C[0.49 0.51 0.00 -0.5 v=831];B[co]C[0.44 0.56 0.00 -1.4 v=600];W[pp]C[0.49 0.51 0.00 -0.3 v=641];B[pq]C[0.45 0.55 0.00 -1.1 v=662];W[hq]C[0.46 0.54 0.00 -0.8 v=786];B[ip]C[0.44 0.56 0.00 -1.2 v=610];W[iq]C[0.49 0.51 0.00 -0.3 v=609];B[jp]C[0.43 0.57 0.00 -1.4 v=680];W[hp]C[0.46 0.54 0.00 -0.9 v=775];B[jq]C[0.44 0.56 0.00 -1.2 v=796];W[fp]C[0.46 0.54 0.00 -0.8 v=779];B[po]C[0.43 0.57 0.00 -1.5 v=1163];W[op]C[0.44 0.56 0.00 -1.2 v=1241];B[qo]C[0.43 0.57 0.00 -1.5 v=1043];W[nm]C[0.46 0.54 0.00 -0.9 v=1402];B[ol]C[0.41 0.59 0.00 -1.8 v=768];W[nl]C[0.47 0.53 0.00 -0.7 v=1049];B[ok]C[0.42 0.58 0.00 -1.6 v=820];W[oq]C[0.48 0.52 0.00 -0.5 v=1087];B[pr]C[0.41 0.59 0.00 -1.7 v=1020];W[oo]C[0.47 0.53 0.00 -0.6 v=1443];B[on]C[0.41 0.59 0.00 -1.8 v=1553];W[nn]C[0.47 0.53 0.00 -0.7 v=1842];B[nc]C[0.41 0.59 0.00 -1.8 v=2006];W[om]C[0.45 0.55 0.00 -1.0 v=632];B[mb]C[0.43 0.57 0.00 -1.4 v=921];W[pn]C[0.51 0.49 0.00 0.0 v=935];B[or]C[0.45 0.55 0.00 -1.0 v=1209];W[kb]C[0.54 0.46 0.00 0.4 v=902];B[lc]C[0.51 0.49 0.00 -0.1 v=652];W[fb]C[0.53 0.47 0.00 0.4 v=944];B[mq]C[0.51 0.49 0.00 0.1 v=676];W[nq]C[0.48 0.52 0.00 -0.3 v=786];B[nr]C[0.48 0.52 0.00 -0.3 v=627];W[rc]C[0.49 0.51 0.00 -0.2 v=764];B[rd]C[0.44 0.56 0.00 -0.9 v=688];W[qd]C[0.47 0.53 0.00 -0.4 v=969];B[re]C[0.43 0.57 0.00 -1.1 v=898];W[pd]C[0.44 0.56 0.00 -0.9 v=1060];B[pe]C[0.40 0.60 0.00 -1.5 v=1334];W[qb]C[0.44 0.56 0.00 -0.9 v=1520];B[qm]C[0.38 0.62 0.00 -1.7 v=1899];W[nj]C[0.41 0.59 0.00 -1.2 v=2039];B[ep]C[0.37 0.63 0.00 -1.9 v=1216];W[eq]C[0.37 0.63 0.00 -1.8 v=1124];B[eo]C[0.38 0.62 0.00 -1.8 v=1531];W[dq]C[0.39 0.61 0.00 -1.5 v=1431];B[gp]C[0.39 0.61 0.00 -1.7 v=1355];W[do]C[0.42 0.58 0.00 -1.2 v=1288];B[rb]C[0.39 0.61 0.00 -1.8 v=1638];W[sb]C[0.40 0.60 0.00 -1.5 v=600];B[fo]C[0.39 0.61 0.00 -1.8 v=870];W[cn]C[0.44 0.56 0.00 -1.0 v=971];B[ob]C[0.42 0.58 0.00 -1.3 v=1085];W[pb]C[0.44 0.56 0.00 -0.9 v=825];B[dn]C[0.44 0.56 0.00 -1.0 v=944];W[bn]C[0.46 0.54 0.00 -0.6 v=1333];B[oj]C[0.45 0.55 0.00 -0.8 v=1247];W[pm]C[0.46 0.54 0.00 -0.6 v=1029];B[ql]C[0.46 0.54 0.00 -0.5 v=1068];W[mp]C[0.48 0.52 0.00 -0.4 v=1236];B[nk]C[0.46 0.54 0.00 -0.6 v=1057];W[pl]C[0.48 0.52 0.00 -0.4 v=603];B[pk]C[0.45 0.55 0.00 -0.7 v=794];W[mk]C[0.48 0.52 0.00 -0.3 v=900];B[mj]C[0.46 0.54 0.00 -0.5 v=1098];W[lk]C[0.51 0.49 0.00 -0.0 v=1146];B[ni]C[0.47 0.53 0.00 -0.4 v=1294];W[qn]C[0.53 0.47 0.00 0.1 v=1141];B[er]C[0.51 0.49 0.00 -0.0 v=1279];W[dr]C[0.57 0.43 0.00 0.4 v=1233];B[rn]C[0.51 0.49 0.00 -0.1 v=1329];W[ho]C[0.59 0.41 0.00 0.5 v=1753];B[em]C[0.54 0.46 0.00 0.1 v=1534];W[ro]C[0.59 0.41 0.00 0.5 v=1640];B[rp]C[0.54 0.46 0.00 0.1 v=1012];W[lq]C[0.61 0.39 0.00 0.7 v=1723];B[mr]C[0.57 0.43 0.00 0.3 v=1465];W[jr]C[0.61 0.39 0.00 0.7 v=2104];B[kr]C[0.58 0.42 0.00 0.4 v=1818];W[fr]C[0.61 0.39 0.00 0.6 v=1294];B[lp]C[0.58 0.42 0.00 0.4 v=1717];W[lo]C[0.63 0.37 0.00 0.7 v=1256];B[kp]C[0.61 0.39 0.00 0.6 v=1825];W[gq]C[0.62 0.38 0.00 0.6 v=1809];B[le]C[0.62 0.38 0.00 0.7 v=2306];W[lj]C[0.60 0.40 0.00 0.5 v=2116];B[li]C[0.57 0.43 0.00 0.3 v=1146];W[kf]C[0.60 0.40 0.00 0.5 v=2337];B[mo]C[0.54 0.46 0.00 0.1 v=700];W[jf]C[0.74 0.26 0.00 1.4 v=626];B[ea]C[0.69 0.31 0.00 1.1 v=650];W[ae]C[0.59 0.41 0.00 0.7 v=600];B[lf]C[0.73 0.27 0.00 1.2 v=858];W[ff]C[0.76 0.24 0.00 1.4 v=609];B[hg]C[0.72 0.28 0.00 1.0 v=965];W[ki]C[0.73 0.27 0.00 1.0 v=1043];B[lh]C[0.71 0.29 0.00 0.9 v=1336];W[ik]C[0.74 0.26 0.00 1.0 v=1346];B[jj]C[0.67 0.33 0.00 0.8 v=1081];W[lm]C[0.69 0.31 0.00 0.9 v=615];B[kc]C[0.58 0.42 0.00 0.4 v=927];W[jc]C[0.66 0.34 0.00 0.7 v=710];B[lb]C[0.57 0.43 0.00 0.3 v=1349];W[ka]C[0.65 0.35 0.00 0.7 v=1296];B[eg]C[0.60 0.40 0.00 0.4 v=825];W[gj]C[0.67 0.33 0.00 1.0 v=1323];B[kj]C[0.64 0.36 0.00 0.8 v=1224];W[ij]C[0.65 0.35 0.00 0.8 v=1727];B[gk]C[0.61 0.39 0.00 0.7 v=675];W[hj]C[0.64 0.36 0.00 0.8 v=1736];B[dg]C[0.60 0.40 0.00 0.4 v=1068];W[ch]C[0.64 0.36 0.00 0.8 v=825];B[ji]C[0.58 0.42 0.00 0.4 v=1022];W[gn]C[0.65 0.35 0.00 1.1 v=1387];B[fa]C[0.63 0.37 0.00 2.0 v=604];W[ga]C[0.73 0.27 0.00 3.0 v=624];B[ir]C[0.68 0.32 0.00 1.8 v=610];W[hl]C[0.82 0.18 0.00 6.7 v=702];B[gm]C[0.86 0.14 0.00 10.2 v=600];W[fn]C[0.88 0.12 0.00 8.6 v=829];B[en]C[0.88 0.12 0.00 7.4 v=609];W[fm]C[0.89 0.11 0.00 6.4 v=1090];B[fl]C[0.90 0.10 0.00 5.8 v=1066];W[jn]C[0.91 0.09 0.00 5.7 v=1183];B[kh]C[0.92 0.08 0.00 8.2 v=613];W[hr]C[0.93 0.07 0.00 1.9 v=698];B[ln]C[0.92 0.08 0.00 1.8 v=694];W[no]C[0.92 0.08 0.00 1.8 v=963];B[id]C[0.93 0.07 0.00 1.8 v=755];W[ic]C[0.93 0.07 0.00 1.8 v=689];B[ko]C[0.93 0.07 0.00 1.8 v=755];W[kn]C[0.93 0.07 0.00 1.8 v=835];B[js]C[0.93 0.07 0.00 1.9 v=826];W[go]C[0.93 0.07 0.00 2.1 v=676];B[hm]C[0.95 0.05 0.00 2.3 v=730];W[im]C[0.95 0.05 0.00 2.0 v=739];B[gl]C[0.95 0.05 0.00 1.9 v=712];W[oa]C[0.96 0.04 0.00 2.2 v=821];C[0.96 0.04 0.00 2.1 v=902 result=W+R])";
const GLOBAL_TAGS = ["tenuki_ok", "urgent_local"];
const SPATIAL_TAGS = ["invasion_viable", "sabaki_required", "reduction_preferred", "cut_available", "ladder_works", "ladder_fails", "base_weak", "aji_present", "big_point_corner", "sente_line"];
let player = new WGo.SimplePlayer(document.getElementById('board'), { sgf: SGF });
let currentMove = 0;
let labels = {};  // move index -> tag mapping
let selectedSpatial = null;

function renderForm() {
  const form = document.getElementById('tag_form');
  form.innerHTML = '';
  form.innerHTML += '<h3>Global tags</h3>';
  GLOBAL_TAGS.forEach(tag => {
    const checked = labels[currentMove] && labels[currentMove][tag] ? 'checked' : '';
    form.innerHTML += `<div class="tag-block"><label><input type="checkbox" data-tag="${tag}" ${checked}/> ${tag}</label></div>`;
  });
  form.innerHTML += '<h3>Spatial tags</h3>';
  SPATIAL_TAGS.forEach(tag => {
    const pts = (labels[currentMove] && labels[currentMove][tag]) || [];
    const checked = selectedSpatial === tag ? 'checked' : '';
    form.innerHTML += `<div class="tag-block"><label><input type="radio" name="spatial" value="${tag}" ${checked}/> ${tag}</label> <span id="${tag}_pts">${pts.map(p => '(' + p[0] + ',' + p[1] + ')').join(' ')}</span></div>`;
  });
}

function renderMarkers() {
  if(player.board && player.board.removeAllObjects) {
    player.board.removeAllObjects();
    const tags = labels[currentMove] || {};
    Object.keys(tags).forEach(tag => {
      const pts = tags[tag];
      if(Array.isArray(pts)) {
        pts.forEach(pt => player.board.addObject({ x: pt[0], y: pt[1], type: 'MA' }));
      }
    });
  }
}

document.getElementById('tag_form').addEventListener('change', e => {
  const tag = e.target.getAttribute('data-tag');
  if(tag) {
    labels[currentMove] = labels[currentMove] || {};
    labels[currentMove][tag] = e.target.checked;
  } else if(e.target.name === 'spatial') {
    selectedSpatial = e.target.value;
  }
});

if(player.board && player.board.addEventListener) {
  player.board.addEventListener('click', (x, y) => {
    if(selectedSpatial === null) return;
    labels[currentMove] = labels[currentMove] || {};
    labels[currentMove][selectedSpatial] = labels[currentMove][selectedSpatial] || [];
    labels[currentMove][selectedSpatial].push([x, y]);
    renderForm();
    renderMarkers();
  });
}

function updateMoveDisplay() {
  document.getElementById('move_idx').textContent = currentMove;
}

function gotoMove(idx) {
  if(idx < 0 || idx >= player.kifu.nodes.length) return;
  while(currentMove < idx) { player.next(); currentMove++; }
  while(currentMove > idx) { player.previous(); currentMove--; }
  updateMoveDisplay();
  renderForm();
  renderMarkers();
}

document.getElementById('next').onclick = () => gotoMove(currentMove + 1);
document.getElementById('prev').onclick = () => gotoMove(currentMove - 1);

document.getElementById('export').onclick = () => {
  const data = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(labels));
  const a = document.createElement('a');
  a.setAttribute('href', data);
  a.setAttribute('download', 'labels.json');
  a.click();
};

renderForm();
updateMoveDisplay();
</script>
</body>
</html>
